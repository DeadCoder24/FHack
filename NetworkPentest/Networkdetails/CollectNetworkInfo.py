try:
    from NetworkPentest.Utility.IpCreator import CreateIp
    from src.Colors import TextColor
    import socket as sock
    from Config.RecOS import IsOSDarwin, IsOSLinux
    from os import getcwd
    import subprocess
    from socket import herror, gethostbyaddr
    from multiprocessing import Pool, cpu_count
    import src.libs as lib
except Exception as error:
    raise SystemExit, '\033[31m' + '%s' % error + '\033[0m'

define_UTIL_PackagePath = getcwd() + "/NetworkPentest/Utility"

VAR_allInfo_IPS = list()
VAR_allInfo_DeviceName = list()
VAR_allInfo_MAC = list()


def MASK():
    print TextColor.GREEN + """
             _   _      _                      _
            | \ | | ___| |___      _____  _ __| | __
            |  \| |/ _ \ __\ \ /\ / / _ \| '__| |/ /
            | |\  |  __/ |_ \ V  V / (_) | |  |   < 
            |_| \_|\___|\__| \_/\_/ \___/|_|  |_|\_\\
                                                    
             ____  _                                   
            |  _ \(_)___  ___ _____   _____ _ __ _   _ 
            | | | | / __|/ __/ _ \ \ / / _ \ '__| | | |
            | |_| | \__ \ (_| (_) \ V /  __/ |  | |_| |
            |____/|_|___/\___\___/ \_/ \___|_|   \__, |
                                                 |___/ 
                                                 
    """ + TextColor.WHITE

    print TextColor.WARNING + "\t\t Your private IP is: "
    print

    if IsOSLinux():
        command = [define_UTIL_PackagePath + '/GetIpInterf.out']
        process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        result = process.communicate()[0]

    elif IsOSDarwin():
        command = [define_UTIL_PackagePath + '/GetIpInterf']
        process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        result = process.communicate()[0]

    print result + TextColor.WHITE
    print


def run_thread(ip):
    try:
        # todo = gather them in list
        deviceInfo = gethostbyaddr(ip)
        deviceName = deviceInfo[0]
        deviceIp = deviceInfo[2]

        # Get Device mac
        arp_request = scapy.ARP(pdst=ip)
        broadcast = scapy.Ether(dst="ff:ff:ff:ff:ff:ff")
        arp_request_broadcast = broadcast / arp_request
        answered_list = scapy.srp(arp_request_broadcast, timeout=1,
                                  verbose=False)[0]

        clients_list = []
        for element in answered_list:
            client_dict = {"ip": element[1].psrc, "mac": element[1].hwsrc}
            clients_list.append(client_dict)

        for client in results_list:
            VAR_allInfo_MAC.append(client["mac"])

        VAR_allInfo_DeviceName.append(deviceName)
        VAR_allInfo_IPS.append(deviceIp)

    except herror:
        pass


def UseIPCreator():
    ip = raw_input(TextColor.CBLUE + "\t~ Fhack/# Enter ip range e.g:(192.168.1.1-192.168.1.100): " + TextColor.WHITE)

    print

    ipList = list()
    for item in CreateIp(ip):
        ipList.append(str(item))

    # create multi thread and then check urls that exists or not
    pool = Pool(processes=cpu_count() + 2)
    pool.map(run_thread, ipList)
    # End

    make_table = lib.mytable(['Count', 'IP', 'Device Name', 'MAC Address'])
    for item in table_name:
        make_table.add_row([str(counter), item])
        counter += 1

    print
    print


def UseIPCalculator():
    """
    With this function we create range of IPs with net mask calculation
    :return:
    """
    pass


def CollectNetworkInfo():
    MASK()

    print TextColor.CYAN + "\t\t [1] Use IPCreator for range of IP"
    print "\t\t [2] Use NetMask for IP Calculator"
    print "\t\t [3] Use single IP"
    print '\t\t [0] Exit' + TextColor.WHITE
    print

    selectedItem = raw_input(TextColor.CVIOLET + '~ Fhack/# Selecte item: ' + TextColor.WHITE)

    if selectedItem == '1':
        UseIPCreator()
    elif selectedItem == '2':
        pass
    elif selectedItem == '3':
        pass
    elif selectedItem == '0':
        print
        return
    else:
        print TextColor.RED + '[-] Please select item <0-3>' + TextColor.WHITE
